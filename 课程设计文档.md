# Natours 旅游预订系统课程设计文档

## 一、项目概述

### 1.1 项目背景
Natours 是一个完整的旅游信息展示和管理系统，为用户提供在线浏览旅游线路、用户注册登录和评价功能。该系统采用现代化的Web技术栈，结合前后端一体化设计，为用户提供流畅的旅游信息查看体验。（预订功能计划在后续版本中实现）

### 1.2 项目目标
- **功能目标**：实现完整的旅游线路浏览、用户注册登录、评价系统功能（预订功能计划后续版本实现）
- **技术目标**：采用MVC架构，实现前后端分离，确保系统的可扩展性和维护性
- **性能目标**：优化数据库查询，实现高效的数据处理和响应
- **安全目标**：实现用户认证授权，保护用户数据和交易安全

### 1.3 项目特色
- 🌍 **地理信息系统集成**：基于Mapbox的地理位置可视化
- 🔐 **多层级安全防护**：JWT认证、角色权限控制、数据加密
- 📱 **响应式设计**：适配多种设备的用户界面
- 🗺️ **GIS查询功能**：支持地理位置查询和距离计算
- ⭐ **用户评价系统**：完整的评分和评论功能

## 二、技术架构

### 2.1 系统架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端展示层     │    │   业务逻辑层     │    │   数据存储层     │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ • Pug模板引擎    │    │ • Express路由    │    │ • MongoDB数据库  │
│ • 前端JavaScript │    │ • 控制器逻辑     │    │ • Mongoose ODM  │
│ • Mapbox地图     │    │ • 认证中间件     │    │ • 数据索引优化   │
│ • CSS样式       │    │ • 错误处理       │    │ • 数据关联       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2.2 技术栈选择

#### 后端技术栈
- **运行时环境**：Node.js (>=18.0.0)
- **Web框架**：Express.js 4.16.4
- **数据库**：MongoDB 4.0+ with Mongoose ODM
- **认证授权**：JWT (JSON Web Token)
- **安全防护**：Helmet, CORS, Rate Limiting
- **文件处理**：Multer, Sharp
- **邮件服务**：Nodemailer

#### 前端技术栈
- **模板引擎**：Pug 2.0.3
- **CSS框架**：自定义CSS，响应式设计
- **JavaScript**：ES6+，Parcel打包
- **地图服务**：Mapbox GL JS
- **HTTP客户端**：Axios

#### 开发工具
- **代码检查**：ESLint (Airbnb配置)
- **代码格式化**：Prettier
- **调试工具**：NDB
- **包管理器**：npm
- **容器化**：Docker & Docker Compose

### 2.3 架构设计原则

#### 分层架构
1. **表现层**：Pug模板和前端JavaScript
2. **控制层**：Express路由和控制器
3. **业务层**：业务逻辑和数据处理
4. **数据层**：MongoDB数据模型

#### 设计模式
- **工厂模式**：通用CRUD操作处理
- **中间件模式**：请求处理链
- **MVC模式**：模型-视图-控制器分离
- **观察者模式**：数据库事件监听

## 三、系统功能模块

### 3.1 用户管理模块

#### 功能清单
- ✅ 用户注册与登录
- ✅ 密码重置功能
- ✅ 用户资料管理
- ✅ 头像上传与裁剪
- ✅ 角色权限控制（用户、导游、领队、管理员）
- ✅ 会话管理（Cookie/Token）

#### 核心功能描述
```javascript
// 用户认证流程
1. 用户注册 → 数据验证 → 密码加密 → 创建用户记录
2. 用户登录 → 凭证验证 → 生成JWT → 设置Cookie → 返回用户信息
3. 访问保护路由 → 验证Token → 检查权限 → 允许/拒绝访问
```

#### 数据模型
```javascript
const userSchema = {
  // 基本信息
  name: String,
  email: { type: String, unique: true },
  photo: String,
  role: { type: String, enum: ['user', 'guide', 'lead-guide', 'admin'] },

  // 认证相关
  password: String,
  passwordConfirm: String,
  passwordChangedAt: Date,
  passwordResetToken: String,
  passwordResetExpires: Date,

  // 状态管理
  active: { type: Boolean, default: true }
}
```

### 3.2 旅游线路管理模块

#### 功能清单
- ✅ 线路信息管理（增删改查）
- ✅ 线路图片上传与处理
- ✅ 地理位置信息管理
- ✅ 线路搜索与过滤
- ✅ 价格管理（折扣、定价策略）
- ✅ 评分系统

#### 核心功能描述
```javascript
// 线路管理功能
1. 创建线路 → 表单验证 → 图片处理 → 地理数据存储 → 数据库保存
2. 线路查询 → 多条件过滤 → 排序 → 分页 → 返回结果
3. 地理查询 → 距离计算 → 范围筛选 → 结果排序
```

#### 数据模型
```javascript
const tourSchema = {
  // 基本信息
  name: String,
  slug: String,
  duration: Number,
  maxGroupSize: Number,
  difficulty: { type: String, enum: ['容易', '中等', '困难'] },

  // 定价信息
  price: Number,
  priceDiscount: Number,

  // 评分系统
  ratingsAverage: { type: Number, default: 4.5, min: 1, max: 5 },
  ratingsQuantity: { type: Number, default: 0 },

  // 描述信息
  summary: String,
  description: String,

  // 媒体资源
  imageCover: String,
  images: [String],

  // 地理信息
  startLocation: {
    type: { type: String, default: 'Point' },
    coordinates: [Number],
    address: String,
    description: String
  },
  locations: [{
    type: { type: String, default: 'Point' },
    coordinates: [Number],
    description: String,
    day: Number
  }],

  // 时间安排
  startDates: [Date]
}
```

### 3.3 预订管理模块

**注意**：预订功能当前版本暂未实现，计划在后续版本中开发。

#### 计划功能清单
- 🔲 在线预订流程
- 🔲 支付处理（Stripe集成）
- 🔲 预订状态管理
- 🔲 用户订单查询
- 🔲 预订取消功能
- 🔲 电子票证生成

### 3.4 评价系统模块

#### 功能清单
- ✅ 用户评价功能
- ✅ 评分统计计算
- ✅ 评价展示与过滤
- ✅ 评价管理（删除、审核）

#### 核心功能描述
```javascript
// 评价系统
1. 用户完成旅行后可进行评价
2. 评分范围：1-5星
3. 评价内容包含文字描述和评分
4. 自动计算平均评分
```

#### 数据模型
```javascript
const reviewSchema = {
  review: String,
  rating: { type: Number, min: 1, max: 5 },
  createdAt: { type: Date, default: Date.now },
  tour: { type: mongoose.Schema.ObjectId, ref: 'Tour', required: [true, 'Review must belong to a tour.'] },
  user: { type: mongoose.Schema.ObjectId, ref: 'User', required: [true, 'Review must belong to a user.'] }
}
```

### 3.5 地理信息系统模块

#### 功能清单
- ✅ 线路位置可视化
- ✅ 距离计算功能
- ✅ 附近线路搜索
- ✅ 地图交互功能

#### 技术实现
```javascript
// GIS查询功能
1. 获取用户位置 → 计算距离 → 筛选范围内线路
2. 地理坐标转换 → GeoJSON格式 → Mapbox渲染
3. 聚合查询 → 统计信息 → 数据可视化
```

## 四、数据库设计

### 4.1 数据库架构图
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    Users    │     │    Tours    │     │   Reviews   │
├─────────────┤     ├─────────────┤     ├─────────────┤
│ _id         │     │ _id         │     │ _id         │
│ name        │     │ name        │     │ review      │
│ email       │     │ slug        │     │ rating      │
│ password    │     │ duration    │     │ createdAt   │
│ role        │     │ price       │     │ tour        │
│ photo       │     │ ratingsAvg  │     │ user        │
│ active      │     │ imageCover  │     └─────────────┘
└─────────────┘     │ locations   │
        │           │ startDates  │
        │           └─────────────┘
        │                  │
        │                  │
        └──────────────────┘
```

### 4.2 核心数据表设计

#### 用户表 (users)
```javascript
{
  _id: ObjectId,
  name: String,
  email: { type: String, unique: true, required: true },
  password: String,
  passwordConfirm: String,
  passwordChangedAt: Date,
  passwordResetToken: String,
  passwordResetExpires: Date,
  photo: String,
  role: { type: String, enum: ['user', 'guide', 'lead-guide', 'admin'], default: 'user' },
  active: { type: Boolean, default: true }
}
```

#### 旅游线路表 (tours)
```javascript
{
  _id: ObjectId,
  name: { type: String, unique: true, required: true },
  slug: String,
  duration: { type: Number, required: true },
  maxGroupSize: { type: Number, required: true },
  difficulty: { type: String, enum: ['容易', '中等', '困难'], required: true },
  price: { type: Number, required: true },
  priceDiscount: Number,
  ratingsAverage: { type: Number, default: 4.5, min: 1, max: 5 },
  ratingsQuantity: { type: Number, default: 0 },
  summary: { type: String, required: true },
  description: String,
  imageCover: { type: String, required: true },
  images: [String],
  createdAt: { type: Date, default: Date.now, select: false },
  startDates: [Date],
  secretTour: { type: Boolean, default: false },
  startLocation: {
    type: { type: String, default: 'Point', enum: ['Point'] },
    coordinates: [Number],
    address: String,
    description: String
  },
  locations: [{
    type: { type: String, default: 'Point', enum: ['Point'] },
    coordinates: [Number],
    address: String,
    description: String,
    day: Number
  }]
}
```

#### 评价表 (reviews)
```javascript
{
  _id: ObjectId,
  review: String,
  rating: { type: Number, min: 1, max: 5 },
  createdAt: { type: Date, default: Date.now },
  tour: { type: ObjectId, ref: 'Tour', required: true },
  user: { type: ObjectId, ref: 'User', required: true }
}
```

#### 预订表 (bookings)
**注意**：预订表在当前版本中暂未实现，计划在后续版本中添加预订功能时启用。

### 4.3 数据库索引设计

#### 用户表索引
```javascript
email: { unique: true }  // 唯一索引
role: 1                 // 角色查询索引
active: 1               // 状态查询索引
```

#### 旅游线路表索引
```javascript
name: { unique: true }  // 唯一索引
slug: { unique: true }  // 唯一索引
price: 1                // 价格排序索引
ratingsAverage: -1      // 评分排序索引
duration: 1             // 时长查询索引
difficulty: 1           // 难度查询索引
'locations.coordinates': '2dsphere'  // 地理空间索引
```

#### 评价表索引
```javascript
tour: 1, user: 1        // 复合索引（防止重复评价）
rating: -1              // 评分排序索引
createdAt: -1           // 时间排序索引
```

## 五、安全设计

### 5.1 认证授权机制

#### JWT认证流程
```javascript
// 登录流程
1. 用户输入凭证 → 服务器验证
2. 生成JWT Token (有效期：JWT_EXPIRES_IN)
3. 设置HttpOnly Cookie (有效期：JWT_COOKIE_EXPIRES_IN)
4. 返回用户信息和认证状态

// 请求验证
1. 客户端发送请求 → 自动携带Cookie
2. 中间件验证JWT → 提取用户信息
3. 权限检查 → 允许/拒绝访问
```

#### 角色权限控制
```javascript
// 权限等级
user: 'user'          // 普通用户
guide: 'guide'        // 导游
lead-guide: 'lead-guide' // 领队导游
admin: 'admin'        // 管理员

// 权限规则
- 普通用户：浏览线路、预订、评价
- 导游：管理分配的线路
- 领队导游：管理所有线路
- 管理员：系统所有功能
```

### 5.2 安全防护措施

#### 网络层安全
- **CORS**：跨域资源共享配置
- **Helmet**：安全头部设置
- **Rate Limiting**：请求频率限制（100次/小时/IP）
- **HTTPS**：生产环境强制HTTPS

#### 数据层安全
- **NoSQL注入防护**：express-mongo-sanitize
- **XSS防护**：xss-clean
- **参数污染防护**：hpp
- **数据验证**：输入数据严格验证

#### 应用层安全
- **密码加密**：bcrypt加密存储
- **Token安全**：JWT签名验证
- **会话管理**：HttpOnly Cookie
- **CSRF防护**：CSRF Token

### 5.3 数据隐私保护

#### 敏感数据处理
```javascript
// 密码处理
- bcrypt加密存储
- 永不返回明文密码
- 密码重置Token有效期限制

// 用户数据
- 敏感字段默认不查询
- 查询结果过滤敏感信息
- 数据传输加密
```

## 六、性能优化

### 6.1 数据库性能优化

#### 查询优化策略
```javascript
// 索引优化
1. 为常用查询字段创建索引
2. 复合索引优化联合查询
3. 地理空间索引优化位置查询
4. 定期分析查询性能

// 查询优化
1. 使用投影减少返回字段
2. 分页查询减少数据量
3. 聚合管道优化复杂查询
4. 避免N+1查询问题
```

#### 缓存策略
```javascript
// 应用层缓存
1. 热门线路数据缓存
2. 用户会话缓存
3. 配置信息缓存

// 数据库缓存
1. MongoDB查询缓存
2. 连接池配置
3. 读写分离
```

### 6.2 前端性能优化

#### 资源优化
```javascript
// 图片优化
1. Sharp库压缩图片
2. WebP格式支持
3. 响应式图片加载
4. 图片懒加载

// JavaScript优化
1. Parcel打包压缩
2. 代码分割
3. 异步加载
4. 缓存策略
```

#### 加载优化
```javascript
// 页面加载
1. 静态资源CDN
2. Gzip压缩
3. 浏览器缓存
4. 预加载关键资源
```

## 七、部署方案

### 7.1 开发环境部署

#### 本地开发环境
```bash
# 环境要求
- Node.js >= 18.0.0
- MongoDB 4.0+
- npm 或 yarn

# 安装步骤
1. git clone 项目
2. npm install 安装依赖
3. 配置环境变量 (.env)
4. npm run dev 启动开发服务器
5. npm run watch:js 监听JS文件变化
```

#### Docker开发环境
```bash
# 使用Docker Compose
1. 配置 docker-compose.yml
2. docker-compose up -d 启动服务
3. 容器间网络通信
4. 数据卷持久化存储
```

### 7.2 生产环境部署

#### 部署架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   负载均衡器    │    │   应用服务器    │    │   数据库集群    │
├─────────────────┤    ├─────────────────┤    ├─────────────────┐
│ • Nginx/ALB     │    │ • Node.js集群   │    │ • MongoDB集群   │
│ • SSL终止       │    │ • PM2进程管理   │    │ • 主从复制      │
│ • 健康检查      │    │ • 日志收集      │    │ • 分片集群      │
│ • 流量分发      │    │ • 监控告警      │    │ • 备份恢复      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

#### 部署步骤
```bash
# 1. 服务器准备
- 云服务器配置（CPU、内存、存储）
- 操作系统更新
- 防火墙配置
- 监控系统部署

# 2. 环境配置
- Node.js生产环境安装
- MongoDB集群部署
- Redis缓存部署
- 环境变量配置

# 3. 应用部署
- 代码仓库配置
- 构建脚本配置
- PM2进程管理
- 负载均衡配置

# 4. 监控维护
- 日志收集系统
- 性能监控
- 错误追踪
- 自动化备份
```

### 7.3 监控与维护

#### 监控指标
```javascript
// 应用监控
- 响应时间
- 错误率
- 并发连接数
- 内存使用率
- CPU使用率

// 业务监控
- 用户注册量
- 线路浏览量
- 用户评价率
```

#### 维护策略
```javascript
// 日常维护
- 日志分析
- 性能监控
- 安全检查
- 数据备份

// 版本更新
- 蓝绿部署
- 回滚机制
- 数据迁移
- 功能测试
```

## 八、项目测试

### 8.1 测试策略

#### 单元测试
```javascript
// 测试范围
- 工具函数测试
- 中间件测试
- 模型验证测试
- 服务层逻辑测试

// 测试工具
- Jest/Mocha
- Sinon
- Chai
- Supertest
```

#### 集成测试
```javascript
// 测试范围
- API接口测试
- 数据库交互测试
- 认证流程测试

// 测试策略
- 端到端测试
- 性能测试
- 安全测试
- 负载测试
```

### 8.2 测试用例设计

#### 用户管理测试
```javascript
// 注册测试
- 正常注册流程
- 重复邮箱注册
- 密码强度验证
- 数据格式验证

// 登录测试
- 正确凭证登录
- 错误凭证登录
- Token验证
- 会话管理
```

#### 旅游线路测试
```javascript
// CRUD测试
- 创建线路
- 查询线路
- 更新线路
- 删除线路

// 搜索测试
- 关键词搜索
- 价格过滤
- 地理位置搜索
- 排序功能
```

## 九、项目总结

### 9.1 技术亮点

#### 架构设计
- ✅ 完整的MVC架构实现
- ✅ RESTful API设计规范
- ✅ 微服务化架构准备
- ✅ 可扩展的模块化设计

#### 技术实现
- ✅ JWT认证授权系统
- ✅ 地理信息系统集成
- ✅ 文件上传处理
- ✅ 邮件系统集成
- ✅ 安全防护多层保障
- 🔄 支付网关集成（计划下一版本）

#### 开发体验
- ✅ 完整的开发工具链
- ✅ 代码质量检查
- ✅ 自动化测试
- ✅ 容器化部署
- ✅ 监控告警系统

### 9.2 项目价值

#### 教学价值
- **全栈开发实践**：前端到后端完整项目
- **企业级开发标准**：代码规范、安全防护
- **现代技术栈应用**：Node.js、MongoDB、JWT等
- **系统架构设计**：分层架构、设计模式
- **运维部署经验**：Docker、监控、维护

#### 商业价值
- **完整的业务流程**：从用户注册到评价完成
- **优秀的用户体验**：响应式设计、流畅交互
- **高度的安全性**：数据保护、用户安全
- **可扩展的架构**：支持业务发展和技术升级
- **清晰的迭代规划**：预订功能预留接口，便于后续扩展

### 9.3 未来展望

#### 功能扩展
- 多语言支持国际化
- 社交媒体集成
- 推荐系统
- 移动端应用
- 数据分析仪表板

#### 技术升级
- GraphQL API
- 微服务架构
- 容器化编排
- 云原生部署
- 人工智能集成

### 9.4 学习要点

#### 核心技术掌握
1. **Node.js与Express**：后端框架应用
2. **MongoDB与Mongoose**：NoSQL数据库设计
3. **JWT认证**：安全认证实现
4. **RESTful API**：API设计规范
5. **MVC架构**：分层架构设计

#### 工程实践
1. **代码规范**：ESLint、Prettier
2. **版本控制**：Git工作流
3. **测试驱动开发**：单元测试、集成测试
4. **持续集成**：自动化构建、部署
5. **容器化**：Docker应用

#### 业务理解
1. **旅游行业业务流程**
2. **用户体验设计**
3. **内容管理系统实现**
4. **用户评价系统设计**
5. **地理信息应用**

---

**项目团队**：梦之旅团队
**完成时间**：2025年10月
**技术支持**：Claude AI助手
**项目地址**：[GitHub Repository]

*注：本课程设计文档基于实际项目实现，涵盖了从需求分析到部署运维的完整软件开发流程。*